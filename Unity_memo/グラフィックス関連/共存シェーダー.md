# 共存シェーダー

o4-mini-high
cmd.SetGlobal～(..), material.Set～(..), renderer.SetPropertyBlock(..), [MaterialProperty("..")]
が共存(従来方式とECS方式)する、HLSLコードとC#コードを書いてください。なのです。

```hlsl
// DotsInstancingExample.shader
Shader "Custom/DotsInstancingExample"
{
    Properties
    {
        _Color ("Color", Color) = (1,1,1,1)
        _GlobalWaveSpeed ("Global Wave Speed", Vector) = (1,0,0,0)
    }
    SubShader
    {
        Tags { "RenderType"="Opaque" }
        Pass
        {
            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            #pragma multi_compile_instancing
            #include "UnityInstancing.hlsl"

            // 従来の uniform 変数（全インスタンス共通）
            float4 _GlobalWaveSpeed;
            float4 _Color;

            // DOTS Instancing 機構のパラメータ定義
            UNITY_DOTS_INSTANCING_START(InstProps)
            UNITY_DOTS_INSTANCING_CBUFFER_START(InstProps)
                UNITY_DOTS_INSTANCED_PROP(float4, _InstanceOffset)
            UNITY_DOTS_INSTANCING_CBUFFER_END(InstProps)

            struct appdata
            {
                float4 vertex : POSITION;
                UNITY_VERTEX_INPUT_INSTANCE_ID;
            };

            struct v2f
            {
                float4 pos : SV_POSITION;
                float4 color : COLOR;
                UNITY_VERTEX_OUTPUT_INSTANCE_ID;
            };

            v2f vert(appdata v)
            {
                v2f o;
                UNITY_SETUP_INSTANCE_ID(v);
                UNITY_TRANSFER_INSTANCE_ID(v, o);

                // per-instance offset
                float4 offset = UNITY_ACCESS_INSTANCED_PROP(InstProps, _InstanceOffset);

                // apply global wave speed
                o.pos = UnityObjectToClipPos(v.vertex);
                o.pos.xy += offset.xy * _GlobalWaveSpeed.xy;

                // use uniform color
                o.color = _Color;
                return o;
            }

            fixed4 frag(v2f i) : SV_Target
            {
                return i.color;
            }
            ENDHLSL
        }
    }
}
```

```csharp
// DotsInstancingExample.cs (GameObject + CommandBuffer example)
using UnityEngine;
using UnityEngine.Rendering;

public class DotsInstancingExample : MonoBehaviour
{
    public Material material;
    public Renderer renderer;

    void Start()
    {
        // 1) グローバル uniform を CommandBuffer で設定
        var cmd = new CommandBuffer { name = "Set Global Wave Speed" };
        cmd.SetGlobalVector("_GlobalWaveSpeed", new Vector4(0.5f, 0, 0, 0));
        Graphics.ExecuteCommandBuffer(cmd);

        // 2) Material.SetVector で uniform を上書き
        material.SetVector("_GlobalWaveSpeed", new Vector4(1f, 0, 0, 0));

        // 3) Renderer.SetPropertyBlock で uniform と Color をさらに上書き
        var block = new MaterialPropertyBlock();
        block.SetVector("_GlobalWaveSpeed", new Vector4(0.2f, 0, 0, 0));
        block.SetColor("_Color", Color.blue);
        renderer.SetPropertyBlock(block);
    }
}
```

```csharp
// DotsInstancingECS.cs (ECS + [MaterialProperty] example)
using Unity.Entities;
using Unity.Mathematics;
using Unity.Rendering;
using Unity.Transforms;

public struct InstanceData : IComponentData
{
    // DOTS Instancing 機構で per-instance に渡
    [MaterialProperty("_InstanceOffset")]
    public float4 InstanceOffset;
}

[UpdateInGroup(typeof(PresentationSystemGroup))]
public class SpawnDotsInstancingEntitiesSystem : SystemBase
{
    protected override void OnCreate()
    {
        // エンティティ生成例
        var entityManager = World.DefaultGameObjectInjectionWorld.EntityManager;
        var archetype = entityManager.CreateArchetype(
            typeof(RenderMesh),
            typeof(LocalToWorld),
            typeof(InstanceData)
        );

        // 10個のインスタンスを生成
        for (int i = 0; i < 10; i++)
        {
            var e = entityManager.CreateEntity(archetype);
            float x = i * 1.5f;
            entityManager.SetComponentData(e, new InstanceData
            {
                InstanceOffset = new float4(x, 0, 0, 0)
            });
        }
    }

    protected override void OnUpdate() { }
}
```
